{% load static %}

<div id="comment-section-wrap">
    <div id="comment-section" class="mx-auto">
        {% if request.user.is_authenticated %}
        <div id="comment-submit-form">
            <div id="comment-submit-my-info" class="flex items-center">
                <img src="{{ user.profile_image.url }}" id="comment-submit-my-info--profile-image">
                <div id="comment-submit-my-info--id">{{user.nickname}}</div>
            </div>
            {% csrf_token %}
            {{form.text}}
            <div class="w-full flex flex-row justify-center">
            <button class="comment-button mx-auto mt-10" id="comment-submit-btn" onclick=commentSubmit()>등록하기</button>
            </div>
        </div>
        {% endif %}

        <div id="comments">
            {% for comment in comments %}
            <div class="comment">
                <div class="comment-info flex items-center">
                    <div class="comment-author flex items-center">
                        <img src="{{comment.author.profile_image.url}}" class="comment-author--profile-image">
                        <div class="comment-author--id">{{comment.author.nickname}}</div>
                    </div>
                    <div class="bar"></div>
                    <div class="comment-create text-center">
                        {{comment.create_at|date:"Y. m. d"}}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{comment.create_at|date:"H : i"}}
                    </div>
                    <div class="bar"></div>
                    <div class="comment-report flex items-center ml-20">
                        <img src="{% static 'images/editors_review/editor_review_detail_comment_report.svg'%}" alt="">
                        <div class="comment-report--report">신고하기</div>
                    </div>
                </div>
                <div class="comment-content relative">
                    <div class="comment-text">
                        <div class="comment-text--text">{{comment.text}}</div>
                        <div class="text-center font-medium mx-auto" id="recomment-write">답글작성</div>
                    </div>
                    <div class="absolute comment-like-button-wrap">
                        <div class="comment-like-button relative"
                            style="background-image: url({% static 'images/editors_review/editor_review_detail_comment_like.svg' %});">
                            <p class="comment-like-count absolute text-center align-text-bottom">000</p>
                        </div>
                    </div>
                </div>
                {% if comment.farmer_story_recomments.exists %}
                <div class="recomment-wrap flex" style="width: 927px; margin-left: 34px;">
                    {% for recomment in comment.farmer_story_recomments.all %}
                    <div class="recomment relative">
                        <div class="flex items-center recomment-info">
                            <div class="recomment-arrow"></div>
                            <div class="recomment-author flex items-center">
                                <img src="{{recomment.author.profile_image.url}}" class="comment-author--profile-image">
                                <div class="comment-author--id">{{recomment.author.nickname}}</div>
                            </div>
                            <div class="bar"></div>
                            <div class="comment-create text-center recomment-create">
                                {{recomment.create_at|date:"Y. m. d"}}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{recomment.create_at|date:"H : i"}}
                            </div>
                            <div class="bar"></div>
                            <div class="recomment-report flex items-center ml-auto">
                                <img src="{% static 'images/editors_review/editor_review_detail_comment_report.svg'%}"
                                    alt="">
                                <div class="comment-report--report">신고하기</div>
                            </div>
                        </div>
                        <div class="absolute" style="top: 41.5px; right: 11.5px;">
                            <div class="recomment-like-button relative"
                                style="background-image: url({% static 'images/editors_review/editor_review_detail_recomment_like.svg' %});">
                                <p class="recomment-like-count absolute text-center align-text-bottom">000</p>
                            </div>
                        </div>
                        <div class="recomment-content">
                            <div class="recomment-text">
                                <div class="recomment-text--text">{{recomment.text}}</div>
                            </div>
                        </div>
                    </div>
                    <div class="horizon-bar mx-auto"></div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<style>
    #recomment-write {
        width: 89px;
        height: 22px;
        border-radius: 11px;
        border: solid 0.5px #989898;
        background-color: #f2f2f2;
        color: #5c6754;
        margin-bottom: 5px;
    }
</style>

<script>
    // 댓글 쓰기 버튼 toggle
    let recomment_form = $('#recomment-submit-form')
    let recomment_btn = $('#recomment-write')

    recomment_form.hide()
    recomment_btn.click(function(){
        recomment_form.toggle()
    })

    // 댓글 작성 ajax
    function commentSubmit(pk) {
        let text = $('#id_text').val();

        $.ajax({
            type: 'POST',
            url: "{% url 'comments:story_comment_create' main_story.pk %}",
            dataType: 'json',
            data: {
                'text': text,
                'pk': '{{ story.pk }}',
                'user': '{{ request.user.pk }}',
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function (data) {

                let comment = `
                <div class="comment">
                    <div class="comment-info flex items-center">
                        <div class="comment-author flex items-center">
                            <img src="${data.user_image}" class="comment-author--profile-image">
                            <div class="comment-author--id">${data.author}</div>
                        </div>
                        <div class="bar"></div>
                        <div class="comment-create text-center">${data.create_at}</div>
                        <div class="bar"></div>
                        <div class="comment-report flex items-center ml-auto">
                            <img src="{% static 'images/editors_review/editor_review_detail_comment_report.svg'%}" alt="">
                            <div class="comment-report--report">신고하기</div>
                        </div>
                    </div>
                    <div class="comment-content relative">
                        <div class="comment-text">
                            <div class="comment-text--text">${data.text}</div>
                            <div class="text-center" id="recomment-write">답글작성</div>
                        </div>
                        <div class="absolute comment-like-button-wrap">
                            <div class="comment-like-button relative"
                                style="background-image: url({% static 'images/editors_review/editor_review_detail_comment_like.svg' %});">
                                <p class="comment-like-count absolute text-center align-text-bottom">000</p>
                            </div>
                        </div>
                    </div>
                </div>`

                $('#comments').prepend(comment);
            },
            error: function () {
                if ($('id_text').val() == '') {
                    alert("댓글을 입력하세요");
                }
            }
        })
    };


</script>