{% load static %}

<div id="comment-section-wrap">
    <div id="comment-section" class="mx-auto">
        {% if request.user.is_authenticated %}
        <div id="comment-submit-form">
            <div id="comment-submit-my-info" class="flex items-center">
                <img src="{{user.profile_image.url}}" id="comment-submit-my-info--profile-image">
                <div id="comment-submit-my-info--id">{{user.nickname}}</div>
            </div>
            {% csrf_token %}
            {{form.text}}
            <button class="comment-button mx-auto" id="comment-submit" onclick=commentSubmit()>올리기</button>
        </div>
        {% endif %}

        <div id="comments">
            {% for comment in comments %}
            <div class="comment" name={{comment.pk}}>
                <div class="comment-info flex items-center">
                    <div class="comment-author flex items-center">
                        <img src="{{comment.author.profile_image.url}}" class="comment-author--profile-image">
                        <div class="comment-author--id">{{comment.author.nickname}}</div>
                    </div>
                    <div class="bar"></div>
                    <div class="comment-create text-center">
                        {{comment.create_at|date:"Y. m. d"}}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{comment.create_at|date:"H : i"}}
                    </div>
                    <div class="bar"></div>
                    <div class="comment-report flex items-center ml-auto">
                        <img src="{% static 'images/editors_review/editor_review_detail_comment_report.svg'%}" alt="">
                        <div class="comment-report--report button" onclick="shootToastMessage('신고를 완료하였습니다.')">신고하기
                        </div>
                    </div>
                </div>
                <div class=" comment-content relative">
                    <div class="comment-text">
                        <div class="comment-text--text">{{comment.text}}</div>
                        <div class="comment-text-options text-right flex justify-between">
                            <div class="comment-text-options--recomment button" onclick="expandRecommentSection(this)">
                                답글
                                {{comment.recomment_count}}개</div>
                            <div class="flex">
                                {% if comment.author == request.user %}
                                <div class="comment-text-options--edit button" onclick=commentEdit(this,{{comment.pk}})>
                                    수정
                                </div>
                                <div class="comment-text-options--delete button" onclick=commentDelete({{comment.pk}})>
                                    삭제</div>
                                {% endif %}
                            </div>
                        </div>
                        <!-- <div class="comment-edit-form-container">
                            <form class="flex flex-col comment-edit-form">
                                <input type="text" class="comment-edit-form-input">
                                <div class="flex items-center justify-between">
                                    <div></div>
                                    <button type="submit" class="comment-edit-submit-button">수정하기</button>
                                    <p class="comment-edit-cancel">취소</p>
                                </div>
                            </form>
                        </div> -->
                    </div>

                    <div class="absolute comment-like-button-wrap">
                        <div class="comment-like-button relative"
                            style="background-image: url({% static 'images/editors_review/editor_review_detail_comment_like.svg' %});">
                            <p class="comment-like-count absolute text-center align-text-bottom">000</p>
                        </div>
                    </div>
                </div>
                <div class="recomment-wrap">
                    {% if request.user.is_authenticated %}
                    <div class="recomment-input-wrapper flex flex-col">
                        <div class="flex items-center recomment-info">
                            <div class="recomment-arrow"></div>
                            <div class="recomment-author flex items-center">
                                <img src="{{user.profile_image.url}}" class="comment-author--profile-image">
                                <div class="comment-author--id">{{request.user.nickname}}</div>
                            </div>
                        </div>
                        <textarea type="text" class="recomment-input-box" name='{{comment.pk}}'></textarea>
                        <button class="recomment-submit-button mx-auto"
                            onclick="recommentSubmit({{comment.pk}})">등록하기</button>
                    </div>
                    <div class="horizon-bar mx-auto"></div>
                    {% endif %}
                    {% for recomment in comment.editor_review_recomments.all %}
                    <div class="recomment relative">
                        <div class="flex items-center recomment-info">
                            <div class="recomment-arrow"></div>
                            <div class="recomment-author flex items-center">
                                <img src="{{recomment.author.profile_image.url}}" class="comment-author--profile-image">
                                <div class="comment-author--id">{{recomment.author.nickname}}</div>
                            </div>
                            <div class="bar"></div>
                            <div class="comment-create text-center recomment-create">
                                {{recomment.create_at|date:"Y. m.d"}}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{recomment.create_at|date:"H : i"}}
                            </div>
                            <div class="bar"></div>
                            <div class="recomment-report flex items-center ml-auto">
                                <img src="{% static 'images/editors_review/editor_review_detail_comment_report.svg'%}"
                                    alt="">
                                <div class="comment-report--report button">신고하기</div>
                            </div>
                        </div>
                        <div class="absolute recomment-like-button-wrap">
                            <div class="recomment-like-button relative"
                                style="background-image: url({% static 'images/editors_review/editor_review_detail_recomment_like.svg' %});">
                                <p class="recomment-like-count absolute text-center align-text-bottom">000</p>
                            </div>
                        </div>
                        <div class="recomment-content flex flex-col">
                            <div class="recomment-text">
                                <div class="recomment-text--text">{{recomment.text}}</div>
                                <div class="recomment-text-options-wrap flex justify-between">
                                    <div></div>
                                    <div class="recomment-text-options flex">
                                        <div class="comment-text-options--edit recomment-text-options--edit button"
                                            onclick="recommentEdit(this, {{recomment.pk}})">수정</div>
                                        <div class="comment-text-options--delete recomment-text-options--delete button"
                                            onclick="recommentDelete({{recomment.pk}})">삭제</div>
                                    </div>
                                </div>
                            </div>
                            <!-- <div class="comment-edit-form-container recomment-edit-form-container mx-auto">
                                <form class="flex flex-col comment-edit-form recomment-edit-form w-full">
                                    <input type="text" class="comment-edit-form-input">
                                    <div class="flex items-center justify-between">
                                        <div></div>
                                        <button type="submit" class="comment-edit-submit-button">수정하기</button>
                                        <p class="comment-edit-cancel recomment-edit-cancel button">취소</p>
                                    </div>
                                </form>
                            </div> -->
                        </div>
                    </div>
                    <div class="horizon-bar mx-auto"></div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
    const commentDelete = (pk) => {
        $.ajax({
            url: '/editors_pick/' + "{{ review.pk }}" + `/comment/delete/${pk}`,
            dataType: 'json',
            data: {},
            success: (data) => {
                const status = data["status"];

                if (status) {
                    alert("댓글이 삭제되었습니다.")
                    location.reload()
                }
            }
        })
    }

    const recommentDelete = pk => {
        $.ajax({
            type: 'POST',
            url: '{% url "editors_pick:recomment_delete" %}',
            dataType: 'json',
            data: {
                'pk': pk,
                'csrfmiddlewaretoken': '{{csrf_token}}'
            },
            success: (data) => {
                if (data.status) {
                    alert("답글이 삭제되었습니다.")
                    location.reload()
                }
            }
        })
    }

    const commentEditForm = `
        <div class="comment-edit-form-container">
            <form class="flex flex-col comment-edit-form">
                <input type="text" class="comment-edit-form-input">
                <div class="flex items-center justify-between">
                    <div></div>
                    <button type="submit" class="comment-edit-submit-button">수정하기</button>
                    <p class="comment-edit-cancel recomment-edit-cancel button">취소</p>
                </div>
            </form>
        </div>`

    const commentEdit = (targetComment, pk) => {
        shootToastMessage("답글을 수정합니다.")
        comment = targetComment.closest(".comment-text-options").previousElementSibling.innerHTML

        targetForm = targetComment.closest(".comment-text")
        targetForm.innerHTML = commentEditForm

        targetInput = targetForm.querySelector(".comment-edit-form-input")
        targetInput.value = comment
        targetInput.focus()


        document.querySelector(".comment-edit-cancel").addEventListener('click', () => {
            showModalMessage('수정을 취소하시겠습니까?', () => {
                location.reload()
            })
        })

        document.querySelector(".comment-edit-form").addEventListener('submit', (e) => {
            e.preventDefault()
            commentEditSubmit(pk)
        })
    }

    const commentEditSubmit = pk => {
        const text = document.querySelector(".comment-edit-form-input").value

        $.ajax({
            type: 'POST',
            url: `/editors_pick/{{review.pk}}/comment/edit/${pk}`,
            dataType: 'json',
            data: {
                'text': text,
                'csrfmiddlewaretoken': '{{csrf_token}}'
            },
            success: function (data) {
                alert("댓글을 수정하였습니다.")
                location.reload()
            },
        });
    }

    const recommentEditForm = `
    <div class="comment-edit-form-container recomment-edit-form-container mx-auto">
        <form class="flex flex-col comment-edit-form recomment-edit-form w-full">
            <input type="text" class="comment-edit-form-input recomment-edit-form-input">
            <div class="flex items-center justify-between">
                <div></div>
                <button type="submit" class="comment-edit-submit-button">수정하기</button>
                <p class="comment-edit-cancel recomment-edit-cancel button">취소</p>
            </div>
        </form>
    </div>
    `

    const recommentEdit = (targetComment, pk) => {
        const comment = targetComment.closest(".recomment-text-options-wrap").previousElementSibling.innerHTML

        targetForm = targetComment.closest(".recomment-text")
        targetForm.innerHTML = recommentEditForm

        targetInput = targetForm.querySelector(".recomment-edit-form-input")
        targetInput.value = comment
        targetInput.focus()


        document.querySelector(".recomment-edit-cancel").addEventListener('click', () => {
            if (confirm("댓글 수정을 취소하시겠습니까?")) {
                location.reload();
            }
        })

        document.querySelector(".recomment-edit-form").addEventListener('submit', (e) => {
            e.preventDefault()
            recommentEditSubmit(pk)
        })
    }

    const recommentEditSubmit = pk => {
        const text = document.querySelector(".recomment-edit-form-input").value


        $.ajax({
            type: 'POST',
            url: "{% url 'editors_pick:recomment_edit' %}",
            dataType: 'json',
            data: {
                'pk': pk,
                'text': text,
                'csrfmiddlewaretoken': '{{csrf_token}}'
            },
            success: (data) => {
                if (data.status) {
                    alert("답글을 수정하였습니다.")
                    location.reload()
                }
            }
        })
    }


    const recommentSubmit = pk => {
        const textBox = document.querySelectorAll('.recomment-input-box')
        const targetComment = [...textBox].filter(elem => parseInt(elem.getAttribute("name")) === pk)
        console.log(targetComment[0].value);



        $.ajax({
            type: 'POST',
            url: `/editors_pick/{{review.pk}}/comment/${pk}/recomment`,
            dataType: 'json',
            data: {
                'text': targetComment[0].value,
                'csrfmiddlewaretoken': '{{csrf_token}}'
            },

            success: function (data) {
                const comment = `
                <div class="recomment relative">
                        <div class="flex items-center recomment-info">
                            <div class="recomment-arrow"></div>
                            <div class="recomment-author flex items-center">
                                <img src="${data.user_image}" class="comment-author--profile-image">
                                <div class="comment-author--id">${data.author}</div>
                            </div>
                            <div class="bar"></div>
                            <div class="comment-create text-center recomment-create">
                                ${data.create_at}
                            </div>
                            <div class="bar"></div>
                            <div class="recomment-report flex items-center ml-auto">
                                <img src="{% static 'images/editors_review/editor_review_detail_comment_report.svg'%}"
                                    alt="">
                                <div class="comment-report--report button">신고하기</div>
                            </div>
                        </div>
                        <div class="absolute recomment-like-button-wrap">
                            <div class="recomment-like-button relative"
                                style="background-image: url({% static 'images/editors_review/editor_review_detail_recomment_like.svg' %});">
                                <p class="recomment-like-count absolute text-center align-text-bottom">000</p>
                            </div>
                        </div>
                        <div class="recomment-content">
                            <div class="recomment-text">
                                <div class="recomment-text--text">${data.text}</div>
                                <div class="recomment-text-options-wrap flex justify-between">
                                    <div></div>
                                    <div class="recomment-text-options flex">
                                        <div class="recomment-text-options--edit button">수정</div>
                                        <div class="recomment-text-options--delete button">삭제</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="horizon-bar mx-auto"></div>
                `

                targetComment[0].parentNode.parentNode.insertAdjacentHTML('beforeend', comment);
                targetComment[0].value = ''
            }
        })
    }


    function commentSubmit() {
        let text = $('#id_text').val();

        $.ajax({
            type: 'POST',
            url: "{% url 'editors_pick:comment' review.pk %}",
            dataType: 'json',
            data: {
                'text': text,
                'pk': '{{review.pk}}',
                'user': '{{request.user.pk}}',
                'csrfmiddlewaretoken': '{{csrf_token}}'
            },
            success: function (data) {

                let comment = `
                <div class="comment" name=${data.pk}>
                    <div class="comment-info flex items-center">
                        <div class="comment-author flex items-center">
                            <img src="${data.user_image}" class="comment-author--profile-image">
                            <div class="comment-author--id">${data.author}</div>
                        </div>
                        <div class="bar"></div>
                        <div class="comment-create text-center">${data.create_at}</div>
                        <div class="bar"></div>
                        <div class="comment-report flex items-center ml-auto">
                            <img src="{% static 'images/editors_review/editor_review_detail_comment_report.svg'%}" alt="">
                            <div class="comment-report--report button">신고하기</div>
                        </div>
                    </div>
                    <div class="comment-content relative">
                        <div class="comment-text">
                            <div class="comment-text--text">${text}</div>
                            <div class="comment-text-options text-right flex justify-between">
                                <div onclick="expandRecommentSection(this)" class="button">답글 0개</div>
                                <div class="flex">
                                    <div class="comment-text-options--edit button" onclick=commentEdit(this,${data.pk})>수정
                                    </div>
                                    <div class="comment-text-options--delete button" onclick=commentDelete(${data.pk})>삭제</div>
                                </div>
                            </div>
                        </div>
                        <div class="absolute comment-like-button-wrap">
                            <div class="comment-like-button relative"
                                style="background-image: url({% static 'images/editors_review/editor_review_detail_comment_like.svg' %});">
                                <p class="comment-like-count absolute text-center align-text-bottom">000</p>
                            </div>
                        </div>
                    </div>
                </div>`

                $('#comments').prepend(comment);
                $('#id_text').val('')
            },
            error: function () {
                if ($('id_text').val() == '') {
                    alert("댓글을 입력하세요");
                }
            }
        })
    };

    const expandRecommentSection = e => {
        e.closest(".comment-content").nextElementSibling.style.display = "inherit"
    }
</script>